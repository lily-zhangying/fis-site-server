<!--
title: 静态资源合并自适应系统
toc: <ul class="nav"><li><a href="#toc_0">现状</a></li><li><a href="#toc_1">静态资源合并自适应方案</a><ul class="nav"><li><a href="#toc_2">数据统计</a><ul class="nav"><li><a href="#toc_3">为什么要运行时收集而不是线下静态分析？</a></li><li><a href="#toc_4">收集哪些静态资源，如何收集？</a></li></ul></li><li><a href="#toc_5">数据分析</a></li><li><a href="#toc_6">打包算法</a></li></ul></li><li><a href="#toc_7">静态资源自动合并优化因素</a><ul class="nav"><li><a href="#toc_8">针对页面多状态优化</a></li><li><a href="#toc_9">网络状况(mobile、PC)</a></li><li><a href="#toc_10">首屏渲染</a></li><li><a href="#toc_11">同步异步</a></li></ul></li></ul>
-->

<p>雅虎性能十四条中有很多都是减少请求数，为了减少请求数通常我们会在上线前把js、css打包合并，图片也会sprite合并。目前业界已经有很多关于CssSprite的自动化工具，基本解决了图片自动合并的问题。而静态资源的合并还停留在原始阶段：工程师根据经验提供合并规则，在通过构建工具完成资源合并。本文就将介绍一个静态资源自动合并自适应系统。</p>

<h2 id="toc_0">现状</h2>

<p>对于比较简单、页面比较少的网站我们很容易根据不同的页面进行资源合并，甚至将所有的资源合并到一起也不会对性能产生很大影响，但当网站比较复杂，有很多静态资源时js、css的打包合并对于开发人员来说就是很痛苦的一件事了。即使我们花很大精力完成了静态资源的优化，可不久你就会发现，页面请求的静态资源正在越来越大，请求数越来越多。人工维护静态资源合并会有以下几个问题 ：</p>

<ul>
<li>无法及时排除不再使用的静态资源，导致资源包越来越大</li>
<li>当页面很多，静态资源之间使用关系很复杂时，人工无法梳理清楚，导致页面会加载一些没有使用的静态资源或者有用的静态资源合并到多个包里，增加了请求数</li>
<li><p>人工优化不具有可持续性，随着开发性能会越来越差</p></li>
<li><p>有过无线开发经验的同学都知道，移动端建立一个网络请求时间更长，所以资源合并打包会更多一些，我们需要根据不同网络进行打包适配</p></li>
</ul>

<p>我们的本意是想优化性能，可到后来我们会发现网站的性能反而越来越差，还浪费了人力成本。并不是资源合并的想法有问题，它可以减少请求数，降低服务器压力确认是一个很好的想法。但问题在于我们通过人工的手段来维护、优化这个日益复杂的合并方案，这是不可行的。我们需要一套可以自动优化静态资源合并方案的工具，这就是我们下面会提到的网站静态资源合并自适应方案。</p>

<h2 id="toc_1">静态资源合并自适应方案</h2>

<p>静态资源自动合并方案是根据页面使用静态资源的情况、以及页面的pv和网络环境(pc、mobile、国外网络)等因素自动生成静态资源合并规则的工具。静态资源自动合并方案分为一下几个实施步骤</p>

<h3 id="toc_2">数据统计</h3>

<p>提供了一套数据采集API，运行时收集页面使用的静态资源，在页面渲染完成后将数据发送到数据统计平台。</p>

<h4 id="toc_3">为什么要运行时收集而不是线下静态分析？</h4>

<blockquote>
<p>同一个模版在不同的状态下加载的静态资源并不完全一样，例如登录和非登录状态，百度百科的不同词条页等。只有运行时才能够准确的收集到每种状态使用的静态资源，以及每种状态所占的PV比例。从而针对常见状态进行打包优化。</p>
</blockquote>

<h4 id="toc_4">收集哪些静态资源，如何收集？</h4>

<blockquote>
<p>由于非组件化资源合并到一起可能会存在变量冲突等问题，静态资源合并只针对组件化资源。系统提供统计API，开发工程师只需要在组件化调用入口添加统计API即可。</p>
</blockquote>

<h3 id="toc_5">数据分析</h3>

<p>分析统计到的数据，算出页面每个状态的pv以及它使用的静态资源。利用分析到的数据构成下图结构：</p>

<p><img src="/static/fis-site/docs/solutions/autopack/images/StaticMap.jpg" alt="alt text" title="Title"/></p>

<p>如上图：横向为所有的静态资源资源的静态方式以及他们的访问量，纵向为网站所有的静态资源。1表示使用了这个资源，0代表没有使用该资源。通过分析统计数据和本地代码我们能够构造出该数据结构。</p>

<h3 id="toc_6">打包算法</h3>

<p>完成数据构造后，我们需要计算哪些资源应该合并到一起。为了衡量哪些资源需要合并，我们提出了两个概念合并收益和合并损失两个概念。下面所说的收益和损失指的都是资源合并对于网站每一个页面的收益和损失。首先介绍两个衡量标准中的常量 ：</p>
<div class="highlight"><pre>RTT<span class="o">(</span>Round Trip Time<span class="o">)</span> ： 一个网络来回的时间
Speed ： 资源的下载速度
</pre></div>
<p>资源合并收益 ：两个静态资源合并到一起，对于页面的收益就是减少了一个请求。</p>
<div class="highlight"><pre>例如上图 A.css和B.css合并，对于网站A、B、C .... Z 页面面，收益就是减少的请求数，再将请求数转化为时间 ：

    收益 <span class="o">=</span> Benefit<span class="o">(</span>A*B<span class="o">)</span> <span class="o">=</span> 10M * RTT + 1M * RTT + 100K * RTT + 20K * RTT + ...... + 1K * RTT

假设C.sss和F.css合并，可以从图中看到没有页面同时使用到这两个静态资源，所以该合并是没有收益的。

    收益 <span class="o">=</span> Benefit<span class="o">(</span>C*F<span class="o">)</span> <span class="o">=</span> 0
</pre></div>
<p>资源合并损失 ：两个资源合并到一起，对于两个资源都使用到的页面是没有损失的，而对于没有只使用到其中一个的页面则增加了资源大小，导致资源下载的时间变长。</p>
<div class="highlight"><pre>例如上图 A.css和B.css合并，由于所有页面都使用到了两个资源所以是没有损失的。

    损失 <span class="o">=</span> Cost<span class="o">(</span>A*B<span class="o">)</span> <span class="o">=</span> 0

同样C.css和F.css合并，A1、A2、B、C这四个页面都只是使用到了一个静态资源，损失为 ：

    损失 <span class="o">=</span> 浪费的总字节数 / 下载速度 <span class="o">=</span> Cost<span class="o">(</span>C*F<span class="o">)</span> <span class="o">=</span> <span class="o">(</span>10M * 400b/1000 + 1M * 400b/1000 + 100K * 400b/1000 + 20K * 300b/1000<span class="o">)</span> / Speed
</pre></div>
<p>最终收益 = 合并收益 - 合并损失。当最终收益大于0时两个静态资源会合并到一起，否则不合并。从上面的分析中可以得到A和B合并的最终收益肯定大于0，这两个静态资源肯定会合并到一起，同理c.css和f.css肯定不会合并到一起。上述两种情况属于比较极端的，要么公用页面，要么全部页面都使用。大多与情况类似与b.css和c.css的关系，如果我们列出上面的计算公式，可以发现b.css和c.css最终能否合并到一起，其实是取决于RTT和Speed的大小。</p>

<p>有了上文介绍的衡量标准，最终我们采用贪心算法每次将资源合并收益最大的进行合并，直到完成所有的资源合并。</p>

<h2 id="toc_7">静态资源自动合并优化因素</h2>

<h3 id="toc_8">针对页面多状态优化</h3>

<p>在数据统计阶段提到过，我们统计的是页面每种状态的pv，例如登录、非登录状态。页面收益损失的计算都是用页面pv作为权重，页面某种状态pv值越高在打包结果中的作用也就越明显。因此自动打包方案会针对页面PV较高，页面不同状态进行打包优化。</p>

<h3 id="toc_9">网络状况(mobile、PC)</h3>

<p>从上面的算法中我们可以看到两个资源收益和损失的大小和RTT以及SPEED有关，而这两个常量则和网络状况有关。因此自动打包方案可以针对无线、PC、国际化等不同的网络环境给出不同的资源合并策略，从而做到在当前网络的最优化。</p>

<h3 id="toc_10">首屏渲染</h3>

<p>在数据统计期间可以标识页面是否达到首屏渲染状态，从而将静态资源分为首屏和非首屏两种类型，分别打包。减少首屏渲染时需要加载的静态资源。</p>

<h3 id="toc_11">同步异步</h3>

<p>同样针对js统计可以分为同步和异步使用的资源，在打包前将资源按照不同的类型区分开。</p>